<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador | TecnoZefe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .preview-img-list { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; }
        .big-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 1rem; display: none; margin-bottom: 1rem; border: 2px solid #3b82f6; }
    </style>
</head>
<body class="p-6">

    <div id="login-block" class="max-w-md mx-auto mt-20 bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl">
        <h2 class="text-2xl font-black text-blue-500 mb-6 text-center italic">ACESSO RESTRITO</h2>
        <input type="password" id="senha-admin" placeholder="Senha" class="w-full p-4 bg-slate-800 rounded-xl mb-4 outline-none border border-slate-700 text-center text-white">
        <button onclick="verificarSenha()" class="w-full bg-blue-600 py-4 rounded-xl font-bold hover:bg-blue-500 transition-all">ENTRAR</button>
    </div>

    <div id="admin-content" class="max-w-5xl mx-auto hidden">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-black text-blue-500 italic">TECNOZEFE <span class="text-white">GERENCIADOR</span></h1>
            <button onclick="location.reload()" class="bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-700">Sair</button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-slate-900 p-6 rounded-3xl border border-slate-800 h-fit sticky top-6">
                <h3 id="form-title" class="text-lg font-bold mb-4 text-blue-400">Novo Produto</h3>
                
                <img id="img-preview-box" class="big-preview" src="">

                <div class="space-y-4">
                    <input type="hidden" id="p-id">
                    
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">Nome</label>
                        <input type="text" id="p-nome" class="w-full p-3 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-blue-500 text-white">
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">Preço</label>
                        <input type="number" step="0.01" id="p-preco" class="w-full p-3 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-blue-500 text-white">
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold ml-1 italic">Foto do Produto</label>
                        <input type="file" id="p-file" accept="image/*" class="w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-600 file:text-white cursor-pointer">
                        <input type="hidden" id="p-img-base64">
                    </div>
                    
                    <button onclick="salvarProduto()" id="btn-salvar" class="w-full bg-blue-600 py-4 rounded-xl font-black hover:bg-blue-500 transition-all text-white">
                        PUBLICAR NO SITE
                    </button>
                    <button id="btn-cancelar" onclick="limparFormulario()" class="w-full bg-slate-700 py-2 rounded-xl text-[10px] font-bold hidden">CANCELAR EDIÇÃO</button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <h3 class="text-lg font-bold mb-6 italic text-slate-400 text-center lg:text-left">Lista de Produtos Online</h3>
                <div id="lista-produtos" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXrCohXhOQ1uyOBctDuZydRo5kP-f6H_A",
            authDomain: "tecnozefe-52c9b.firebaseapp.com",
            projectId: "tecnozefe-52c9b",
            storageBucket: "tecnozefe-52c9b.firebasestorage.app",
            messagingSenderId: "855053573330",
            appId: "1:855053573330:web:fa2a29347519cf9b59610b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // TRANSFORMA IMAGEM EM TEXTO (BASE64) PARA SALVAR NO BANCO
        const fileInput = document.getElementById('p-file');
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    document.getElementById('img-preview-box').src = base64String;
                    document.getElementById('img-preview-box').style.display = 'block';
                    document.getElementById('p-img-base64').value = base64String;
                }
                reader.readAsDataURL(file);
            }
        });

        window.verificarSenha = () => {
            if(document.getElementById('senha-admin').value === "zefe123") {
                document.getElementById('login-block').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                carregarLista();
            } else { alert("Senha incorreta!"); }
        }

        async function carregarLista() {
            const container = document.getElementById('lista-produtos');
            container.innerHTML = '<p class="text-blue-500 animate-pulse text-center">Sincronizando com o banco...</p>';
            
            try {
                const q = query(collection(db, "produtos"), orderBy("data", "desc"));
                const querySnapshot = await getDocs(q);
                container.innerHTML = '';

                querySnapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    container.innerHTML += `
                        <div class="bg-slate-900 border border-slate-800 p-3 rounded-2xl flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-4">
                                <img src="${p.imagem}" class="preview-img-list bg-slate-800" onerror="this.src='https://via.placeholder.com/60'">
                                <div>
                                    <h4 class="font-bold text-sm">${p.nome}</h4>
                                    <p class="text-blue-400 text-xs font-black">R$ ${p.preco.toFixed(2).replace('.', ',')}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="prepararEdicao('${id}', '${p.nome}', ${p.preco}, '${p.imagem}')" class="w-10 h-10 bg-slate-800 text-yellow-500 rounded-lg hover:bg-slate-700 transition-all"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="excluirProduto('${id}')" class="w-10 h-10 bg-slate-800 text-red-500 rounded-lg hover:bg-slate-700 transition-all"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            } catch (e) { container.innerHTML = "Erro: " + e; }
        }

        window.salvarProduto = async () => {
            const btn = document.getElementById('btn-salvar');
            const id = document.getElementById('p-id').value;
            const nome = document.getElementById('p-nome').value;
            const preco = document.getElementById('p-preco').value;
            const img = document.getElementById('p-img-base64').value;

            if(!nome || !preco || !img) return alert("Por favor, preencha tudo e selecione uma foto!");

            btn.disabled = true;
            btn.innerText = "SALVANDO NO BANCO...";

            try {
                const dados = { nome, preco: parseFloat(preco), imagem: img, data: new Date() };
                if(id) {
                    await updateDoc(doc(db, "produtos", id), dados);
                } else {
                    await addDoc(collection(db, "produtos"), dados);
                }
                limparFormulario();
                carregarLista();
                alert("Site atualizado com sucesso!");
            } catch (e) { alert("Erro ao salvar: " + e); }
            btn.disabled = false;
        }

        window.excluirProduto = async (id) => {
            if(confirm("Remover este produto do site?")) {
                await deleteDoc(doc(db, "produtos", id));
                carregarLista();
            }
        }

        window.prepararEdicao = (id, nome, preco, img) => {
            document.getElementById('p-id').value = id;
            document.getElementById('p-nome').value = nome;
            document.getElementById('p-preco').value = preco;
            document.getElementById('p-img-base64').value = img;
            document.getElementById('img-preview-box').src = img;
            document.getElementById('img-preview-box').style.display = 'block';
            document.getElementById('form-title').innerText = "Editando Produto";
            document.getElementById('btn-salvar').innerText = "SALVAR ALTERAÇÕES";
            document.getElementById('btn-cancelar').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.limparFormulario = () => {
            document.getElementById('p-id').value = "";
            document.getElementById('p-nome').value = "";
            document.getElementById('p-preco').value = "";
            document.getElementById('p-img-base64').value = "";
            document.getElementById('p-file').value = "";
            document.getElementById('img-preview-box').style.display = 'none';
            document.getElementById('form-title').innerText = "Novo Produto";
            document.getElementById('btn-salvar').innerText = "PUBLICAR NO SITE";
            document.getElementById('btn-cancelar').classList.add('hidden');
        }

        window.verificarSenha = verificarSenha;
        window.salvarProduto = salvarProduto;
        window.excluirProduto = excluirProduto;
        window.prepararEdicao = prepararEdicao;
        window.limparFormulario = limparFormulario;

    </script>
</body>
</html>